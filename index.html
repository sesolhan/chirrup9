<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì„¸ì†”ì˜ ë¸”ë¡œê·¸</title>
<style>
  :root{
    --bg:#f7f7fb; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --card:#fff;
    --accent:#111827;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
  header{position:sticky;top:0;z-index:3;background:#fff;border-bottom:1px solid var(--line);padding:18px 16px}
  header h1{margin:0;font-size:20px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  /* ì¤‘ì•™ì„  2ì—´ ë ˆì´ì•„ì›ƒ */
  .layout{display:grid;grid-template-columns:1fr 3px 1fr;gap:28px;align-items:start}
  .divider{background:linear-gradient(180deg,#00000010,#00000020,#00000010);border-radius:2px;min-height:80vh}
  /* ì™¼ìª½: ìƒë‹¨ ë™ê·¸ë¼ë¯¸(íƒœê·¸) */
  .stories{display:flex;gap:12px;padding:6px 0 18px;overflow:auto}
  .story{flex:0 0 auto;width:62px;height:62px;border-radius:999px;border:2px solid #d1d5db;display:flex;align-items:center;justify-content:center;background:#fff;cursor:pointer}
  .story.active{border-color:#111}
  .story span{font-size:12px;text-align:center;line-height:1.1;padding:6px;color:#111;display:block}
  /* ë‚ ì§œ */
  .date{margin:24px 0 10px;font-weight:700;color:#111}
  /* ì¹´ë“œ */
  article{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px 18px;margin:10px 0;box-shadow:0 6px 16px rgba(0,0,0,.04)}
  article h2{margin:0 0 6px;font-size:18px}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .post-tags{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f3f4f6;border:1px solid var(--line)}
  .content{white-space:pre-wrap;line-height:1.55}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px}
  .like{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .empty{padding:40px;text-align:center;color:var(--muted)}
  /* ì˜¤ë¥¸ìª½ ë¯¸ë””ì–´ íŒ¨ë„ */
  .media{position:sticky;top:84px;border:1px solid var(--line);border-radius:16px;background:#fff;min-height:300px;
    display:flex;align-items:center;justify-content:center;overflow:hidden}
  .media img{max-width:100%;height:auto;display:block}
  .media video{width:100%;height:auto;display:block}
  .media iframe{width:100%;aspect-ratio:16/9;border:0}
  .media .placeholder{color:var(--muted);padding:40px;text-align:center}
  /* ë°˜ì‘í˜•(ëª¨ë°”ì¼ì€ ì„¸ë¡œ ìŠ¤íƒ) */
  @media (max-width:900px){
    .layout{grid-template-columns:1fr;gap:16px}
    .divider{display:none}
    .media{position:static}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ì„¸ì†”ì˜ ë¸”ë¡œê·¸</h1>
    <div class="muted" style="color:var(--muted);font-size:13px">ì™¼ìª½: íƒœê·¸/ë‚ ì§œ/ì¹´ë“œ Â· ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€/ì˜ìƒ</div>
  </div>
</header>

<div class="wrap">
  <div class="layout">
    <!-- ì™¼ìª½ -->
    <section id="left">
      <!-- ë™ê·¸ë¼ë¯¸ íƒœê·¸ -->
      <div id="storyBar" class="stories"></div>
      <!-- ë‚ ì§œë³„ ê²Œì‹œê¸€ -->
      <div id="list"></div>
    </section>

    <!-- ì¤‘ì•™ì„  -->
    <div class="divider" aria-hidden="true"></div>

    <!-- ì˜¤ë¥¸ìª½: ë¯¸ë””ì–´ -->
    <aside id="right">
      <div id="media" class="media"><div class="placeholder">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì´ë¯¸ì§€/ì˜ìƒì´ ë³´ì…ë‹ˆë‹¤</div></div>
    </aside>
  </div>
</div>

<script>
  /* === ì„¤ì • === */
  const SHEET_ID   = "YOUR_SHEET_ID_HERE";         // â† ì‹œíŠ¸ IDë¡œ êµì²´
  const SHEET_NAME = "";                            // íƒ­ ì´ë¦„ì´ ìˆìœ¼ë©´ ì…ë ¥ (ì˜ˆ: "ë¸”ë¡œê·¸")
  const GVIZ = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json` +
               (SHEET_NAME ? `&sheet=${encodeURIComponent(SHEET_NAME)}` : "");

  // (ì„ íƒ) ì „ì—­ ì¢‹ì•„ìš” ì§‘ê³„ìš© Apps Script ì›¹ì•± URL (ì—†ìœ¼ë©´ ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš©)
  const GAS_ENDPOINT = ""; // ì˜ˆ: "https://script.google.com/macros/s/XXX/exec"
  const SHEET_NAME_FOR_GAS = SHEET_NAME;

  /* === ìœ í‹¸/íŒŒì„œ === */
  const headerMap = {
    id:        ['id','ì•„ì´ë””'],
    title:     ['title','ì œëª©'],
    body:      ['body','ë³¸ë¬¸','ë‚´ìš©','content'],
    tags:      ['tags','íƒœê·¸'],
    likes:     ['likes','ì¢‹ì•„ìš”','like','í•˜íŠ¸'],
    date:      ['date','ë‚ ì§œ','ì¼ì'],
    published: ['published','publish','ê³µê°œ','ë…¸ì¶œ','ê²Œì‹œ'],
    media:     ['media','ì´ë¯¸ì§€','ì˜ìƒ','ë¯¸ë””ì–´','image','video','url']
  };

  function parseGviz(text){
    const json = JSON.parse(text.substring(47).slice(0,-2));
    const labels = json.table.cols.map(c => String(c.label||'').toLowerCase().trim());

    const colOf = (key)=>{
      const aliases = headerMap[key];
      const idx = labels.findIndex(l=>aliases.includes(l));
      return idx === -1 ? null : idx;
    };

    const idx = {
      id: colOf('id'), title: colOf('title'), body: colOf('body'), tags: colOf('tags'),
      likes: colOf('likes'), date: colOf('date'), published: colOf('published'), media: colOf('media')
    };

    const rows = json.table.rows.map(r=>{
      const get = (i)=> {
        if(i===null) return "";
        const cell = r.c[i];
        return cell?.f ?? cell?.v ?? "";
      };
      const pubRaw = get(idx.published);
      const published = (idx.published===null) ? true
        : (String(pubRaw).toLowerCase()==="true" || pubRaw===true);

      return {
        id:   String(get(idx.id)   || "").trim(),
        title:String(get(idx.title)|| "").trim(),
        body: String(get(idx.body) || "").trim(),
        tags: String(get(idx.tags) || "").split(",").map(s=>s.trim()).filter(Boolean),
        likes:Number(get(idx.likes)|| 0),
        date: String(get(idx.date) || "").trim(),
        media:String(get(idx.media)|| "").trim(),
        published
      };
    });

    return rows.filter(r=>r.published && r.title);
  }

  /* === ë Œë” === */
  const $list  = document.getElementById('list');
  const $media = document.getElementById('media');
  const $stories = document.getElementById('storyBar');

  function groupByDate(posts){
    const map = new Map();
    posts.forEach(p=>{
      const key = p.date || "ë‚ ì§œ ë¯¸ìƒ";
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(p);
    });
    return Array.from(map.entries()).sort((a,b)=> (b[0]||"").localeCompare(a[0]||""));
  }

  const likeKey = id => `like-${id}`;
  const getLocalLikes = (id, initial=0)=> Number(localStorage.getItem(likeKey(id)) ?? initial);
  const incLocalLikes = (id)=> localStorage.setItem(likeKey(id), getLocalLikes(id,0)+1);

  function renderList(posts){
    if(!posts.length){ $list.innerHTML = `<div class="empty">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

    const grouped = groupByDate(posts);
    $list.innerHTML = grouped.map(([date, items])=>{
      const cards = items.map(p=>{
        const pid = p.id || `post-${Math.random().toString(36).slice(2)}`;
        const likeCount = getLocalLikes(pid, p.likes);
        const tagHtml = p.tags.map(t=>`<span class="pill" data-tag="${t}">#${t}</span>`).join("");

        return `
          <article data-id="${pid}" data-media="${encodeURIComponent(p.media)}" data-tags="${p.tags.join(',')}">
            <h2>${p.title}</h2>
            <div class="meta">${date}${p.likes?` Â· ì¢‹ì•„ìš” ${likeCount}`:""}</div>
            <div class="post-tags">${tagHtml}</div>
            <div class="content">${p.body}</div>
            <div class="toolbar">
              <button class="like" data-like="${pid}">
                <span>ğŸ‘</span><span id="count-${pid}">${likeCount}</span>
              </button>
              <button class="like" data-preview="${pid}">ë¯¸ë””ì–´ ë³´ê¸° â–¶</button>
            </div>
          </article>
        `;
      }).join("");
      return `<div class="date">${date}</div>${cards}`;
    }).join("");
  }

  function renderStories(allTags){
    const tags = ['ì „ì²´', ...Array.from(allTags).sort()];
    $stories.innerHTML = tags.map(t=>`
      <button class="story" data-filter="${t}">
        <span>${t}</span>
      </button>`).join("");
    const first = $stories.querySelector('[data-filter="ì „ì²´"]');
    if(first) first.classList.add('active');
  }

  function applyTagFilter(tag){
    document.querySelectorAll('#list article').forEach(a=>{
      const tags = a.getAttribute('data-tags').split(',').filter(Boolean);
      a.style.display = (tag==='ì „ì²´' || !tag) ? '' : (tags.includes(tag) ? '' : 'none');
    });
  }

  function showMediaFromArticle($article){
    if(!$article) return;
    const url = decodeURIComponent($article.getAttribute('data-media') || "");
    if(!url){ $media.innerHTML = `<div class="placeholder">ì´ ê²Œì‹œë¬¼ì— ì—°ê²°ëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

    if(/(youtube\.com\/watch\?v=|youtu\.be\/)/.test(url)){
      const id = url.match(/(?:v=|youtu\.be\/)([^&?/]+)/)?.[1] || "";
      $media.innerHTML = `<iframe src="https://www.youtube-nocookie.com/embed/${id}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    }else if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(url)){
      $media.innerHTML = `<video controls playsinline src="${url}"></video>`;
    }else{
      $media.innerHTML = `<img src="${url}" alt="" />`;
    }
  }

  // ì „ì—­ í´ë¦­(ì¢‹ì•„ìš” + ë¯¸ë””ì–´ ë¯¸ë¦¬ë³´ê¸° + íƒœê·¸ í•„í„°)
  document.addEventListener('click', async (e)=>{
    // íƒœê·¸ ë™ê·¸ë¼ë¯¸
    const story = e.target.closest('.story');
    if(story){
      $stories.querySelectorAll('.story').forEach(s=>s.classList.remove('active'));
      story.classList.add('active');
      applyTagFilter(story.getAttribute('data-filter'));
      return;
    }
    // ë¯¸ë””ì–´ ë³´ê¸°
    const prevBtn = e.target.closest('[data-preview]');
    if(prevBtn){
      const pid = prevBtn.getAttribute('data-preview');
      const art = document.querySelector(`#list article[data-id="${pid}"]`);
      showMediaFromArticle(art);
      return;
    }
    // ì¢‹ì•„ìš”
    const likeBtn = e.target.closest('[data-like]');
    if(likeBtn){
      const id = likeBtn.getAttribute('data-like');
      const label = document.getElementById(`count-${id}`);
      label.textContent = Number(label.textContent||0) + 1; // ë‚™ê´€ì 
      if(GAS_ENDPOINT){
        try{
          const qs = new URLSearchParams({ id, ...(SHEET_NAME_FOR_GAS? {sheet:SHEET_NAME_FOR_GAS} : {}) });
          const res = await fetch(`${GAS_ENDPOINT}?${qs.toString()}`);
          const json = await res.json();
          if(json.ok && typeof json.likes==='number') label.textContent = json.likes;
        }catch(err){ /* ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ë§Œ ìœ ì§€ */ }
      }else{
        incLocalLikes(id);
      }
      return;
    }
    // ì¹´ë“œ í´ë¦­ ì‹œë„ â†’ ë¯¸ë””ì–´ í‘œì‹œ
    const art = e.target.closest('#list article');
    if(art){ showMediaFromArticle(art); }
  });

  async function load(){
    try{
      const r = await fetch(GVIZ);
      const rows = parseGviz(await r.text())
        .sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      renderList(rows);
      renderStories(new Set(rows.flatMap(r=>r.tags)));
      // ì´ˆê¸° ë¯¸ë””ì–´(ì²« ë²ˆì§¸ ì¹´ë“œ)
      const first = document.querySelector('#list article');
      if(first) showMediaFromArticle(first);
    }catch(e){
      $list.innerHTML = `<div class="empty">ì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì›¹ì— ê²Œì‹œ/íƒ­/í—¤ë” í™•ì¸)<br><small>${String(e)}</small></div>`;
      console.error(e);
    }
  }
  load();
</script>
</body>
</html>
